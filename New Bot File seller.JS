const BOT_TOKEN = '7584002135:AAH7b-Wg5b5HrUgA_2RntVnypTPLBVf75qs'; // ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª
const ZARINPAL_MERCHANT_ID = '1344b5d4-0048-11e8-94db-005056a205be'; // Ù…Ø±Ú†Ù†Øª Ø¢ÛŒØ¯ÛŒ Ø²Ø±ÛŒÙ†â€ŒÙ¾Ø§Ù„
const ADMINS = ["MajidMirshekari76", "Moriparvaz"]; // Ø¢ÛŒØ¯ÛŒ Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§
const BOT_ID = "Mori_Seller_Bot"; // Ø¢ÛŒØ¯ÛŒ Ø±Ø¨Ø§Øª
const TIME_ZONE = "Asia/Tehran"; // Ù…Ù†Ø·Ù‚Ù‡ Ø²Ù…Ø§Ù†ÛŒ
const ZARINPAL_TEST_MODE = true; // Ø­Ø§Ù„Øª ØªØ³Øª Ø²Ø±ÛŒÙ†â€ŒÙ¾Ø§Ù„

export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);

    const botValues = env.bot_values_link; // KV Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ±
    const botDB = env.dblink; // Ø¯ÛŒØªØ§Ø¨ÛŒØ³ D1

    // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…
    async function postReq(url, fields) {
      const tgFormData = new FormData();
      fields.forEach(obj => {
        for (let key in obj) {
          tgFormData.append(key, obj[key]);
        }
      });
      const telegramResponse = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/${url}`, {
        method: 'POST',
        body: tgFormData,
      });
      return await telegramResponse.json();
    }

    // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ø§Ø¹Ø¯Ø§Ø¯ ÙØ§Ø±Ø³ÛŒ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ
    function engNumber(input) {
      let inputString = String(input);
      let persianToEnglish = inputString.replace(/[\u06F0-\u06F9]/g, (digit) =>
        String.fromCharCode(digit.charCodeAt(0) - 1728)
      let arabicToEnglish = persianToEnglish.replace(/[\u0660-\u0669]/g, (digit) =>
        String.fromCharCode(digit.charCodeAt(0) - 1584)
      let numericString = arabicToEnglish.replace(/\D/g, '');
      return parseInt(numericString, 10);
    }

    // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ø§Ø¹Ø¯Ø§Ø¯ Ø¨Ù‡ ÙØ±Ù…Øª ÙØ§Ø±Ø³ÛŒ
    function toFarsiNumberFormat(input) {
      let inputString = String(input);
      let formattedNumber = inputString.replace(/\B(?=(\d{3})+(?!\d))/g, 'ØŒ');
      let farsiNumber = formattedNumber.replace(/\d/g, (digit) =>
        String.fromCharCode(digit.charCodeAt(0) + 1728)
      );
      return farsiNumber;
    }

    // ØªÙ†Ø¸ÛŒÙ… ÙˆØ¨â€ŒÙ‡ÙˆÚ©
    if (url.pathname === "/init") {
      try {
        const array = new Uint8Array(32);
        crypto.getRandomValues(array);
        const webhookkey = Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
        await botValues.put("webhookkey", webhookkey);

        const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/setWebhook`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            url: `${url.protocol}//${url.hostname}/hook/${webhookkey}`,
            allowed_updates: ["message", "chat_member"] // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø§ÛŒÙˆÙ†Øª chat_member
          })
        });

        const result = await response.json();
        if (result.ok) {
          return new Response("Webhook successfully set!", { status: 200 });
        } else {
          return new Response(`Failed to set webhook: ${result.description}`, { status: 400 });
        }
      } catch (error) {
        return new Response(`Error setting webhook: ${error.message}`, { status: 500 });
      }
    }

    // Ù¾Ø±Ø¯Ø§Ø®Øª
    if (url.pathname.startsWith("/order")) {
      const orderid = url.searchParams.get('id');
      const rkey = url.searchParams.get('key');

      const requestOrder = await botDB.prepare(`SELECT * FROM orders WHERE id = ?`).bind(orderid).first();

      if (rkey == requestOrder.random_key) {
        const orderedfile = await botDB.prepare(`SELECT * FROM files WHERE id = ?`).bind(requestOrder.fileid).first();

        const headers = {
          "accept": "application/json",
          "content-type": "application/json",
        };

        const body = JSON.stringify({
          merchant_id: ZARINPAL_MERCHANT_ID,
          amount: orderedfile.price * 10,
          description: "order " + orderedfile.title,
          callback_url: `${url.protocol}//${url.hostname}/verify/?orderid=${orderid}&key=${requestOrder.random_key}`
        });

        const zarinpal_request_url = ZARINPAL_TEST_MODE
          ? "https://sandbox.zarinpal.com/pg/v4/payment/request.json"
          : "https://api.zarinpal.com/pg/v4/payment/request.json";

        const zarinpal_req_pay_response = await fetch(zarinpal_request_url, {
          method: "POST",
          headers,
          body,
        });

        const zarinpal_req_pay_result = await zarinpal_req_pay_response.json();

        await botDB.prepare(`UPDATE orders SET payment_data = ? where id = ?`).bind(
          JSON.stringify({
            bank: "zarinpal",
            authority: zarinpal_req_pay_result.data.authority,
            amount: orderedfile.price * 10
          }),
          requestOrder.id,
        ).run();

        const zarinpal_payURL = ZARINPAL_TEST_MODE
          ? `https://sandbox.zarinpal.com/pg/StartPay/${zarinpal_req_pay_result.data.authority}`
          : `https://www.zarinpal.com/pg/StartPay/${zarinpal_req_pay_result.data.authority}`

        const redirectingPage = `<!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Ù¾Ø±Ø¯Ø§Ø®Øª</title>
            <style>
                body {
                    margin: 0;
                    height: 100vh;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-family: Arial, sans-serif;
                    background-color: #121212;
                    color: #ffffff;
                }
                .container {
                    text-align: center;
                    max-width: 400px;
                    width: 100%;
                    padding: 20px;
                    border-radius: 10px;
                    background-color: #1e1e1e;
                    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
                    position: relative;
                }
                .close-button {
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background-color: #d9534f;
                    color: #ffffff;
                    border: none;
                    border-radius: 50%;
                    width: 30px;
                    height: 30px;
                    font-size: 18px;
                    font-weight: bold;
                    text-align: center;
                    line-height: 30px;
                    cursor: pointer;
                    transition: background-color 0.3s ease;
                    padding:0px
                }
                .close-button:hover {
                    background-color: #c9302c;
                }
                input {
                    width: 100%;
                    padding: 10px;
                    border-radius: 5px;
                    border: 1px solid #333;
                    background-color: #2e2e2e;
                    color: #ffffff;
                    margin-bottom: 10px;
                    text-align: center;
                    cursor: pointer;
                }
                button {
                    padding: 10px 20px;
                    border: none;
                    border-radius: 5px;
                    background-color: #3a7bd5;
                    color: #ffffff;
                    cursor: pointer;
                    font-size: 16px;
                }
                button:hover {
                    background-color: #2a68b1;
                }
                p {
                    font-size: 14px;
                    color: #cccccc;
                }
                .copy-message {
                    position: absolute;
                    top: -30px;
                    left: 50%;
                    transform: translateX(-50%);
                    background-color: #28a745;
                    color: #ffffff;
                    padding: 5px 10px;
                    border-radius: 5px;
                    font-size: 12px;
                    display: none;
                }
            </style>
        </head>
        <body>
        <script>
        function cw() {
          try {
               window.TelegramWebviewProxy.postEvent('web_app_close', null);
           } catch (error) {
               console.error('Error posting event to Telegram Webview:', error);
           }
        }
        </script>
            <div class="container">
                <button class="close-button" onclick="cw()">X</button>
                <div id="copy-message" class="copy-message">Copied!</div>
                <h1>Ù¾Ø±Ø¯Ø§Ø®Øª</h1>
                <input type="text" id="payment-url" value="${zarinpal_payURL}" readonly onclick="copyToClipboard()">
                <p>Ø´Ù…Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§ÛŒÙ† Ù„ÛŒÙ†Ú© Ø±Ø§ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø®Ø§Ø±Ø¬ÛŒ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯.</p>
                <p>(Ø¨Ø²Ù† Ø±ÙˆØ´ Ú©Ù¾ÛŒ Ù…ÛŒØ´Ù‡)</p>
                <button onclick="continuePayment()">Ø§Ø¯Ø§Ù…Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ù‡Ù…ÛŒÙ†Ø¬Ø§</button>
            </div>
            <script>
                function copyToClipboard() {
                    const input = document.getElementById('payment-url');
                    input.select();
                    input.setSelectionRange(0, 99999); // For mobile devices
                    navigator.clipboard.writeText(input.value).then(() => {
                        showCopyMessage();
                    });
                }
        
                function showCopyMessage() {
                    const message = document.getElementById('copy-message');
                    message.style.display = 'block';
                    setTimeout(() => {
                        message.style.display = 'none';
                    }, 1500);
                }
        
                function continuePayment() {
                    const url = document.getElementById('payment-url').value;
                    window.location.href = url;
                }
            </script>
        </body>
        </html>
        `;

        return new Response(redirectingPage, {
          status: 200,
          headers: {
            "Content-Type": "text/html",
            "Cache-Control": "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0",
            "Pragma": "no-cache",
            "Expires": "0",
          },
        });
      }
    }

    // ØªØ§ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª
    if (url.pathname.startsWith("/verify")) {
      const orderid = url.searchParams.get('orderid');
      const rkey = url.searchParams.get('key');
      const Authority = url.searchParams.get('Authority');

      const verifyingOrder = await botDB.prepare(`SELECT * FROM orders WHERE id = ?`).bind(orderid).first();

      var sendit = 0;

      if (rkey == verifyingOrder.random_key) {
        const payment_data = JSON.parse(verifyingOrder.payment_data);

        if (payment_data.bank == 'zarinpal') {
          const headers = {
            "accept": "application/json",
            "content-type": "application/json",
          };

          const body = JSON.stringify({
            merchant_id: ZARINPAL_MERCHANT_ID,
            authority: payment_data.authority,
            amount: payment_data.amount,
          });

          const zarinpal_verifyURL = ZARINPAL_TEST_MODE
            ? `https://sandbox.zarinpal.com/pg/v4/payment/verify.json`
            : `https://api.zarinpal.com/pg/v4/payment/verify.json`

          const zarinpalVerifyResponse = await fetch(zarinpal_verifyURL, {
            method: "POST",
            headers,
            body,
          });

          const zarinpalVerifyResponseJson = await zarinpalVerifyResponse.json();

          const payDate = new Intl.DateTimeFormat('en-US', {
            timeZone: TIME_ZONE,
            dateStyle: 'full',
            timeStyle: 'long',
          }).format(new Date());

          const insertNewFile = await botDB.prepare(`INSERT INTO payment_history (order_id, payment_data, payment_date)
          VALUES (?1, ?2, ?3)`).bind(
            orderid,
            String(JSON.stringify(zarinpalVerifyResponseJson)),
            String(payDate)
          ).run();

          if (zarinpalVerifyResponseJson.data.code == 100) {
            sendit = 1;

            await postReq(`editMessageReplyMarkup`, [
              { "chat_id": verifyingOrder.userid },
              { "message_id": verifyingOrder.payMsg },

              {
                "reply_markup": JSON.stringify({
                  "inline_keyboard": [
                    [
                      {
                        "text": "âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯",
                        "url": `https://t.me/${BOT_ID}`
                      }
                    ]
                  ]
                })
              }
            ]);

            await botDB.prepare(`UPDATE orders SET status = ? where id = ?`).bind(
              1,
              orderid,
            ).run();

          } else if (zarinpalVerifyResponseJson.data.code == 101) {
            sendit = 2;
          }
        }

        const htmlPage = `<!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>[PAGE_TITLE]</title>
            <style>
              body {
                background-color: #121212;
                color: #ffffff;
                font-family: Arial, sans-serif;
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                margin: 0;
                text-align: center;
                flex-direction: column;
                direction:rtl
              }
              h1, h2 {
                margin: 0;
              }
              h1 {
                font-size: 2em;
                margin-bottom: 0.5em;
              }
              h2 {
                font-size: 1.5em;
                font-weight: normal;
                margin-bottom: 1em;
              }
              a {
                display: inline-block;
                padding: 0.5em 1em;
                color: #ffffff;
                background-color: #007bff;
                text-decoration: none;
                border-radius: 5px;
                font-size: 1em;
                margin-top: 1em;
              }
              a:hover {
                background-color: #0056b3;
              }
              #countdowncontainer {
                font-size:1.5rem;            
              }
              #countdown {
                font-weight:bold;
                color:#ff00a5;
                font-size:1.8rem
              }
            </style>
          </head>
          <body>
            [BODY]

          <div>
          <script>
          function cw() {
         try {
              window.TelegramWebviewProxy.postEvent('web_app_close', null);
          } catch (error) {
              console.error('Error posting event to Telegram Webview:', error);
          }
          }
          </script>

          <p id="countdowncontainer">Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… Ø¯Ø± <span id="countdown">8</span> Ø«Ø§Ù†ÛŒÙ‡...</p>
           <div> <a onclick="cw()" href="tg://resolve?domain=${BOT_ID}">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…</a> </div>       

          </div>
          
          <script>
          let countdown = 8; // 8 seconds
          const countdownElement = document.getElementById("countdown");
          
          const interval = setInterval(() => {
            countdown -= 1;
            countdownElement.textContent = countdown;
            if (countdown <= 0) {
              clearInterval(interval);
              cw();
              window.location.href = "tg://resolve?domain=${BOT_ID}";
            }
          }, 1000); // Update every 1 second
        </script>
         

          </body>
          </html>`;

        if (sendit === 1) {
          const filexx = await botDB.prepare(`SELECT * FROM files WHERE id = ?`).bind(verifyingOrder.fileid).first();

          await postReq(`copyMessage`, [
            { "chat_id": verifyingOrder.userid },
            { "from_chat_id": filexx.from_chat_id },
            { "message_id": filexx.message_id }
          ]);

          return new Response(htmlPage.replace("[BODY]", `<div>
          <h1>âœ…Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯</h1>
          <h2>âœ…ÙØ§ÛŒÙ„ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯</h2>
          </div>`).replace("[PAGE_TITLE]", "Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯"), {
            status: 200,
            headers: {
              'Content-Type': 'text/html; charset=UTF-8',
            }
          });

        } else if (sendit === 2) {
          return new Response(htmlPage.replace("[BODY]", `
          <div> <h1>âÙØ§ÛŒÙ„ Ù‚Ø¨Ù„Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ Ø§Ø³Øª</h1></div>
        `).replace("[PAGE_TITLE]", "ÙØ§ÛŒÙ„ Ù‚Ø¨Ù„Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡"), {
            status: 200,
            headers: {
              'Content-Type': 'text/html; charset=UTF-8',
            }
          });
        } else {
          return new Response(htmlPage.replace("[BODY]", `
          <div><h1>âŒØ®Ø·Ø§: Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø´Ø¯</h1></div>
          `).replace("[PAGE_TITLE]", "Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø®Øª"), {
            status: 200,
            headers: {
              'Content-Type': 'text/html; charset=UTF-8',
            }
          });
        }
      }
    }

    // Ù‡Ù†Ø¯Ù„Ø± ÙˆØ¨â€ŒÙ‡ÙˆÚ©
    if (url.pathname.startsWith("/hook")) {
      const reqHook = url.pathname.split('/hook/')[1];

      if (reqHook == await botValues.get("webhookkey")) {
        if (request.method === "POST") {
          try {
            const body = await request.json();

            // Ù¾ÛŒØ§Ù… Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ
            if (body.chat_member) {
              const chatId = body.chat_member.chat.id;
              const newStatus = body.chat_member.new_chat_member.status;

              if (newStatus === "member") { // Ú©Ø§Ø±Ø¨Ø± Ø±Ø¨Ø§Øª Ø±Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù‡
                await postReq(`sendMessage`, [
                  { "chat_id": chatId },
                  { "text": "ğŸ‘‹ Ø³Ù„Ø§Ù…! Ø¨Ù‡ Ø±Ø¨Ø§Øª ÙØ±ÙˆØ´ ÙØ§ÛŒÙ„ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯.\nØ¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Start Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯." }
                ]);
              }
            }

            // Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§
            if (body.message && body.message.text === "/start") {
              const chatId = body.message.chat.id;

              // Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³
              const categories = await botDB.prepare(`SELECT * FROM categories`).all();

              if (categories.results.length > 0) {
                const buttons = categories.results.map(category => [
                  { text: category.name, callback_data: `category_${category.id}` }
                ]);

                await postReq(`sendMessage`, [
                  { "chat_id": chatId },
                  { "text": "Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:" },
                  { "reply_markup": JSON.stringify({ inline_keyboard: buttons }) }
                ]);
              } else {
                await postReq(`sendMessage`, [
                  { "chat_id": chatId },
                  { "text": "Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ù‡ÛŒÚ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯." }
                ]);
              }
            }

            // Ù†Ù…Ø§ÛŒØ´ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ÛŒÚ© Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ
            if (body.callback_query && body.callback_query.data.startsWith("category_")) {
              const categoryId = body.callback_query.data.split("_")[1];
              const chatId = body.callback_query.message.chat.id;

              // Ø¯Ø±ÛŒØ§ÙØª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ
              const files = await botDB.prepare(`SELECT * FROM files WHERE category_id = ?`).bind(categoryId).all();

              if (files.results.length > 0) {
                for (const file of files.results) {
                  const previewText = file.preview || "Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.";
                  const priceText = toFarsiNumberFormat(file.price) + " ØªÙˆÙ…Ø§Ù†";

                  await postReq(`sendPhoto`, [ // ÛŒØ§ sendMessage Ø§Ú¯Ø± Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ù…ØªÙ† Ø§Ø³Øª
                    { "chat_id": chatId },
                    { "photo": file.preview }, // ÛŒØ§ { "text": previewText }
                    { "caption": `${previewText}\n\nÙ‚ÛŒÙ…Øª: ${priceText}` },
                    { "reply_markup": JSON.stringify({
                      inline_keyboard: [
                        [{ text: "Ø®Ø±ÛŒØ¯ ÙØ§ÛŒÙ„", callback_data: `buy_${file.id}` }]
                      ]
                    })}
                  ]);
                }
              } else {
                await postReq(`sendMessage`, [
                  { "chat_id": chatId },
                  { "text": "Ø¯Ø± Ø§ÛŒÙ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ ÙØ§ÛŒÙ„ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯." }
                ]);
              }
            }

            // Ù¾Ø±Ø¯Ø§Ø®Øª Ùˆ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ ÙØ§ÛŒÙ„
            if (body.callback_query && body.callback_query.data.startsWith("buy_")) {
              const fileId = body.callback_query.data.split("_")[1];
              const chatId = body.callback_query.message.chat.id;

              const array = new Uint8Array(8);
              crypto.getRandomValues(array);
              const rndKey = Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');

              const insertOrder = await botDB.prepare(`INSERT INTO orders (userid,fileid,random_key) VALUES (?1, ?2, ?3)`).bind(
                String(chatId),
                fileId,
                rndKey
              ).run();

              const requestFile = await botDB.prepare(`SELECT * FROM files WHERE id = ?`).bind(fileId).first();
              const requestFileCaption = JSON.parse(requestFile.caption);
              const Caption = requestFileCaption['text'] + "\n Ù‚ÛŒÙ…Øª: " + toFarsiNumberFormat(requestFile.price) + " ØªÙˆÙ…Ø§Ù†"

              const payBtn = JSON.stringify({
                "inline_keyboard": [
                  [
                    {
                      "text": "Ù¾Ø±Ø¯Ø§Ø®Øª Ø¢Ù†Ù„Ø§ÛŒÙ†",
                      "web_app": {
                        "url": url.protocol + "//" + url.hostname + "/order/?id=" + insertOrder.meta.last_row_id + "&key=" + rndKey
                      }
                    }
                  ]
                ]
              });

              let payMsgResponse = null;

              if (requestFileCaption['type'] == 'text') {
                payMsgResponse = await postReq(`sendMessage`, [
                  { "chat_id": chatId },
                  { "text": Caption },
                  { "reply_markup": payBtn }
                ]);
              } else {
                payMsgResponse = await postReq(`copyMessage`, [
                  { "chat_id": chatId },
                  { "from_chat_id": requestFile["from_chat_id"] },
                  { "caption": Caption },
                  { "message_id": requestFileCaption["message_id"] },
                  { "reply_markup": payBtn }
                ]);
              }

              const payMsgResponseJson = await payMsgResponse.json();

              await botDB.prepare(`UPDATE orders SET payMsg = ? where id = ?`).bind(
                String(payMsgResponseJson.result.message_id),
                insertOrder.meta.last_row_id,
              ).run();
            }
          } catch (e) {
            // Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§
          }
        }
        return new Response("", { status: 200 });
      } else {
        return new Response("wrong webhook", { status: 200 });
      }
    }

    return new Response("ok", { status: 200 });
  }
};